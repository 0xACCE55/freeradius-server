#! /usr/bin/make -f
#
#	debian/rules file for freeradius
#

SHELL=/bin/bash

# export DH_VERBOSE=1

package = freeradius
tmp     = $(shell pwd)/debian/tmp

prefix	= /
exec_prefix	= /usr
mandir	= $(exec_prefix)/share/man
libdir	= $(exec_prefix)/lib/freeradius
logdir	= /var/log/freeradius
pkgdocdir	= $(exec_prefix)/share/doc/radiusd-freeradius

build: sanitycheck clean
# Builds the binary package.
	dh_testdir
	# dh_testroot
	./configure --prefix=$(prefix) --exec-prefix=$(exec_prefix) --libdir=$(libdir) --mandir=$(mandir) --with-logdir=$(logdir) --with-thread-pool --enable-ltdl-install=no
	make
	touch build

# Architecture independant files.
binary-indep: clean

# Make a binary package (.deb file)
binary-arch:	build
	dh_clean
	dh_installdirs
	make install prefix=$(prefix) exec_prefix=$(exec_prefix) mandir=$(mandir) libdir=$(libdir) R=$(tmp)
	# clean up install cruft.  $$&@!%
	rmdir $(tmp)/include
	rm $(tmp)/usr/sbin/rc.radiusd
	# man pages & docs
	dh_undocumented 
	install -g root -m 644 CREDITS $(tmp)$(pkgdocdir)/credits
	find doc -type f -maxdepth 1 ! -path doc/ChangeLog -exec dh_installdocs {} \;
	dh_installchangelogs doc/ChangeLog
	dh_compress
	# supporting programs
	install -g root -m 755 scripts/radiusd.cron.daily $(tmp)/etc/cron.daily/freeradius
	install -g root -m 755 scripts/radiusd.cron.monthly $(tmp)/etc/cron.monthly/freeradius
	install -g root -m 755 scripts/rc.radiusd $(tmp)/etc/init.d/freeradius
	# fix up conf file  --  all of these should be commented on in README.Debian
	cp $(tmp)/etc/raddb/radiusd.conf newconf
	cat newconf \
		| sed -e 's/        /	/g' \
		| sed -e '/^	example {/,/^	}/s/^/#deb#/' \
		| sed -e '/^	sql .*{/,/^	}/s/^/#deb#/' \
		| sed -e '/^	always .*{/,/^	}/s/^/#deb#/' \
		| sed -e 's/^		#	shadow		=/		shadow		=/' \
		| sed -e 's/^group = nobody/group = nogroup/' \
			> $(tmp)/etc/raddb/radiusd.conf
	rm newconf
	# 
	dh_strip
	dh_installdeb
	dh_installchangelogs
	dh_compress
	dh_fixperms
	dh_makeshlibs
	dh_shlibdeps
	dh_md5sums
	dh_gencontrol
	dh_builddeb

clean:	
	dh_clean
	[ -f Make.inc ] && make distclean || true
	rm -f build debian/{files,substvars} debian/*.debhelper
	rm -rf $(tmp)

binary: binary-indep binary-arch

sanitycheck:
	@echo -n "sanity: checking for overzealous undocumented file... "
	@find man/ -type f |grep \. |sed -e 's%man/man./%%' | { \
		while read manpage; do \
			grep $$manpage debian/undocumented | read filename && echo -n $$filename; \
		done; \
	} || true
	@test -n $$filename
	@echo good.

	@echo -n "sanity: making sure conffiles lists all raddb files... "
	@{ \
		tree=`find raddb/ -type f |egrep -v '\.in$$' |grep -v CVS |grep -v /Makefile |sort`; \
		debconf=`grep raddb debian/conffiles |sed -e 's%/etc/%%' |sort`; \
		test "$$tree" = "$$debconf"; \
	}
	@echo good.

.PHONY: binary binary-arch binary-indep clean sanitycheck
