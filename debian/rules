#! /usr/bin/make -f
#
#	debian/rules file for freeradius
#

SHELL=/bin/bash

# Name.
package = freeradius
tmp     = $(shell pwd)/debian/tmp

define checkdir
	test -f src/main/radiusd.c
endef

build:
# Builds the binary package.
	$(checkdir)
	./configure --prefix=/ --exec_prefix='/usr' --infodir='$${exec_prefix}/share/info' --mandir='$${exec_prefix}/share/man' --with-datadir='$${exec_prefix}/share' --includedir='$${exec_prefix}/include' --with-thread-pool --with-logdir='/var/log/radius'
	make
	touch build

# Architecture independant files.
binary-indep:   build
	$(checkdir)

# Make a binary package (.deb file)
binary-arch:	build checkroot
	-rm -rf $(tmp)
	dh_installdirs
	make install prefix=/ exec_prefix=/usr R=$(tmp)
	for documented in man1/radlast.1 man5/acct_users.5 man8/builddbm.8; do \
		chmod 644 $(tmp)/usr/share/man/$${documented}; \
		gzip -9 $(tmp)/usr/share/man/$${documented}; \
	done
	dh_undocumented check-radiusd-config.1 checkrad.1 radiusd.1 radtest.1 radwatch.1 radwho.1 radzap.1
	chmod 644 $(tmp)/usr/lib/*
	#strip --strip-unneeded $(tmp)/usr/lib/*.{a,so.*}
	dh_strip
	#
	install -g root -m 644 COPYRIGHT $(tmp)/usr/share/doc/freeradius/copyright
	install -g root -m 644 CREDITS $(tmp)/usr/share/doc/freeradius/credits
	rm $(tmp)/usr/sbin/rc.radiusd; install -g root -m 755 scripts/rc.radiusd $(tmp)/etc/init.d/radiusd
	install -g root -m 755 scripts/radiusd.cron.daily $(tmp)/etc/cron.daily/radiusd
	install -g root -m 755 scripts/radiusd.cron.monthly $(tmp)/etc/cron.monthly/radiusd
	dh_installdeb
	dh_installchangelogs
	dh_makeshlibs
	dh_shlibdeps
	dh_compress
	dh_fixperms
	dh_gencontrol
	dpkg --build $(tmp) ..
	rm -rf $(tmp)

clean:	checkroot
	[ -f Make.inc ] && make distclean || true
	rm -f build debian/{files,substvars}
	rm -rf $(tmp)

binary: binary-indep binary-arch

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary binary-arch binary-indep clean checkroot
