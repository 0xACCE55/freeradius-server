#! /usr/bin/make -f
#
#	debian/rules file for freeradius
#

SHELL=/bin/bash

# Name.
package = freeradius
tmp     = $(shell pwd)/debian/tmp

prefix	= /
exec_prefix	= /usr
mandir	= $(exec_prefix)/share/man
pkgdocdir	= $(exec_prefix)/share/doc/freeradius

define checkdir
	test -f src/main/radiusd.c
endef

build:
# Builds the binary package.
	$(checkdir)
	./configure --prefix=$(prefix) --exec-prefix=$(exec_prefix) --mandir=$(mandir) --with-thread-pool --enable-ltdl-install=no
	make
	touch build

# Architecture independant files.
binary-indep:   build
	$(checkdir)

# Make a binary package (.deb file)
binary-arch:	build checkroot
	dh_clean
	dh_installdirs
	make install prefix=$(prefix) exec_prefix=$(exec_prefix) mandir=$(mandir) R=$(tmp)
	# clean up install cruft.  $$&@!%
	rmdir $(tmp)/include
	rm $(tmp)/usr/sbin/rc.radiusd
	# man pages & docs
	find $(tmp)$(mandir) -type f -exec gzip -9 {} \;  # policy, sec 6.1
	dh_undocumented 
	install -g root -m 644 CREDITS $(tmp)$(pkgdocdir)/credits
	dh_installdocs doc/*
	dh_installchangelogs $(tmp)$(pkgdocdir)/ChangeLog
	# supporting programs
	install -g root -m 755 scripts/rc.radiusd $(tmp)/etc/init.d/radiusd
	install -g root -m 755 scripts/radiusd.cron.daily $(tmp)/etc/cron.daily/radiusd
	install -g root -m 755 scripts/radiusd.cron.monthly $(tmp)/etc/cron.monthly/radiusd
	# fix up conf file  --  all of these should be commented on in README.Debian
	cp $(tmp)/etc/raddb/radiusd.conf newconf
	cat newconf \
		| sed -e 's/        /	/g' \
		| sed -e 's/       /	/g' \
		| sed -e '/^	pam {/,/^	}/s/^/#deb#/' \
		| sed -e 's/^	pam$$/#deb#	pam/' \
		| sed -e 's/^	radutmp$$/#deb#	radutmp/' \
		| sed -e '/^	example {/,/^	}/s/^/#deb#/' \
		| sed -e '/^	sql .*{/,/^	}/s/^/#deb#/' \
		| sed -e 's/^		#	shadow		=/		shadow		=/' \
		| sed -e 's/^group = nobody/group = nogroup/' \
			> $(tmp)/etc/raddb/radiusd.conf
	rm newconf
	# 
	dh_strip
	dh_installdeb
	dh_installchangelogs
	dh_compress
	dh_fixperms
	dh_makeshlibs
	dh_shlibdeps
	dh_md5sums
	dh_gencontrol
	dh_builddeb
	dh_clean

clean:	checkroot
	dh_clean
	[ -f Make.inc ] && make distclean || true
	rm -f build debian/{files,substvars}

binary: binary-indep binary-arch

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary binary-arch binary-indep clean checkroot
