#
# $Id$
#

include ../../Make.inc

SERVER_SRCS	= radiusd.c files.c util.c acct.c nas.c log.c valuepair.c \
		  version.c proxy.c exec.c auth.c conffile.c \
		  modules.c modcall.c session.c xlat.c threads.c smux.c \
		  radius_snmp.c client.c request_list.c mainconfig.c \
		  request_process.c

SERVER_OBJS	+= $(SERVER_SRCS:.c=.o)

INCLUDES	= ../include/radiusd.h ../include/radius.h ../include/libradius.h ../include/conf.h ../include/autoconf.h

CFLAGS		+= -I../include 
CFLAGS		+= -DHOSTINFO=\"${HOSTINFO}\"
CFLAGS          += -DRADIUSD_VERSION=\"${RADIUSD_VERSION}\"
CFLAGS          += $(SNMP_INCLUDE) 
LDFLAGS		+= -L../lib
MODULE_LIBS	= $(STATIC_MODULES)
MODULE_OBJS	=
VFLAGS		= -DRADIUSD_MAJOR_VERSION=$(RADIUSD_MAJOR_VERSION)
VFLAGS		+= -DRADIUSD_MINOR_VERSION=$(RADIUSD_MINOR_VERSION)
BINARIES	= radiusd radwho radclient radrelay radsqlrelay
LT_BIN_FLAGS	=

#
#  Not using shared libraries, add in ALL known static modules
# at build time.
#
ifneq ($(USE_SHARED_LIBS),yes)
#
#  For static linking...
#
LT_BIN_FLAGS	= -static -all-static

SUB_MODULES += rlm_eap_md5 rlm_eap_leap rlm_eap_tls rlm_eap_ttls rlm_eap_sim
SUB_MODULES += rlm_eap_peap rlm_eap_mschapv2 rlm_eap_gtc
SUB_MODULES += rlm_sql_db2 rlm_sql_freetds rlm_sql_iodbc rlm_sql_mysql
SUB_MODULES += rlm_sql_oracle rlm_sql_postgresql rlm_sql_sybase rlm_sql_unixodbc
LIBS        += $(shell test -f ../modules/rlm_eap/libeap/libeap.a && echo -L../modules/rlm_eap/libeap -leap)

#
MODULE_LIBS	+= $(shell for x in $(MODULES);do test -f ../modules/$$x/$$x.la && echo -dlpreopen ../modules/$$x/$$x.la;done)
MODULE_LIBS	+= $(shell for x in $(SUB_MODULES);do test -f ../modules/*/types/$$x/$$x.la && echo -dlpreopen ../modules/*/types/$$x/$$x.la;done)
MODULE_LIBS	+= $(shell for x in $(SUB_MODULES);do test -f ../modules/*/drivers/$$x/$$x.la && echo -dlpreopen ../modules/*/drivers/$$x/$$x.la;done)
MODULE_OBJS	+= $(shell for x in $(MODULES);do test -f ../modules/$$x/$$x.la && echo ../modules/$$x/$$x.la;done)
MODULE_OBJS	+= $(shell for x in $(SUB_MODULES);do test -f ../modules/*/types/$$x/$$x.la && echo ../modules/*/types/$$x/$$x.la;done)
MODULE_OBJS	+= $(shell for x in $(SUB_MODULES);do test -f ../modules/*/drivers/$$x/$$x.la && echo ../modules/*/drivers/$$x/$$x.la;done)
else

#
#  Weird EAP nonsense
#
ifeq ($(RLM_EAP_LINK_MODE),-static)
LIBS        += $(shell test -f ../modules/rlm_eap/libeap/libeap.a && echo -L../modules/rlm_eap/libeap -leap)
MODULE_LIBS	+= $(shell for x in rlm_eap_tls rlm_eap_ttls rlm_eap_peap;do test -f ../modules/*/types/$$x/$$x.la && echo -dlpreopen ../modules/*/types/$$x/$$x.la;done)
endif
endif

LIBS		+= -lradius $(SNMP_LIBS)


all:	$(BINARIES)

$(SERVER_OBJS): $(INCLUDES)

radiusd: $(SERVER_OBJS) ../lib/libradius.la $(MODULE_OBJS)
	$(LIBTOOL) --mode=link $(CC) -export-dynamic -dlopen self \
		$(LT_BIN_FLAGS) $(CFLAGS) $(LDFLAGS) -o $@ \
		$(SERVER_OBJS) $(LCRYPT) $(MODULE_LIBS) $(LIBS) \
		$(PTHREADLIB) $(LIBLTDL) $(LCRYPT) $(OPENSSL_LIBS)

radiusd.o: radiusd.c ../include/request_list.h ../include/modules.h ../include/modcall.h ../include/modpriv.h
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c radiusd.c

acct.o: acct.c ../include/modules.h
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c acct.c

files.o: files.c 
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c files.c

util.o: util.c 
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c util.c

nas.o:  nas.c 
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c nas.c

log.o:  log.c 
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c log.c

conffile.o: conffile.c ../include/modules.h
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c conffile.c

mainconfig.o: mainconfig.c ../include/modules.h
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c mainconfig.c

modules.o:  modules.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) $(VFLAGS) $(INCLTDL) -c modules.c

modcall.o:  modcall.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) $(INCLTDL) -c modcall.c

session.o:  session.c ../include/modules.h
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c session.c

request_list.o:  request_list.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c request_list.c

request_process.o:  request_process.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c request_process.c

proxy.o:  proxy.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c proxy.c

exec.o:  exec.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c exec.c

auth.o:  auth.c ../include/modules.h
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c auth.c

valuepair.o:  valuepair.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c valuepair.c

version.o: version.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -o version.o -c version.c

xlat.o: xlat.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -o xlat.o -c xlat.c

threads.o: threads.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -o threads.o -c threads.c

smux.o: smux.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -o smux.o -c smux.c

radius_snmp.o: radius_snmp.c
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -o radius_snmp.o -c radius_snmp.c

radclient: radclient.o ../lib/libradius.la
	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o radclient radclient.o ../lib/libradius.la $(LIBS)

radclient.o: radclient.c $(INCLUDES)
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c radclient.c

radrelay: radrelay.o util.o log.o conffile.o ../lib/libradius.la
	$(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o radrelay radrelay.o util.o log.o conffile.o $(LIBS)

radrelay.o: radrelay.c $(INCLUDES)
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c radrelay.c

radsqlrelay: radsqlrelay.o mainconfig.o util.o nas.o client.o log.o conffile.o files.o xlat.o valuepair.o ../lib/libradius.la
	$(LIBTOOL) --mode=link $(CC) -export-dynamic -dlopen self $(CFLAGS) $(LDFLAGS) -o radsqlrelay radsqlrelay.o mainconfig.o util.o nas.o client.o log.o conffile.o files.o xlat.o valuepair.o $(LIBLTDL) $(LCRYPT) $(LIBS)

radsqlrelay.o: radsqlrelay.c $(INCLUDES)
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) $(INCLTDL) -c radsqlrelay.c

radwho.o: radwho.c $(INCLUDES)
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c radwho.c

radwho: radwho.o util.o log.o conffile.o ../lib/libradius.la
	$(LIBTOOL) --mode=link $(CC) $(LDFLAGS) -o radwho radwho.o util.o log.o conffile.o ../lib/libradius.la $(LIBS)

clean:
	rm -rf *.o *.so *.lo *~ $(BINARIES) .libs

install:
	$(LIBTOOL) --mode=install $(INSTALL) -m 755 $(INSTALLSTRIP) radiusd$(EXEEXT)	$(R)$(sbindir)
	$(LIBTOOL) --mode=install $(INSTALL) -m 755 $(INSTALLSTRIP) radwho$(EXEEXT)	$(R)$(bindir)
	$(LIBTOOL) --mode=install $(INSTALL) -m 755 $(INSTALLSTRIP) radzap	$(R)$(bindir)
	$(INSTALL) -m 755    radlast			$(R)$(bindir)
	$(LIBTOOL) --mode=install $(INSTALL) -m 755    radclient$(EXEEXT)		$(R)$(bindir)
	$(LIBTOOL) --mode=install $(INSTALL) -m 755    radrelay$(EXEEXT)		$(R)$(bindir)
	$(LIBTOOL) --mode=install $(INSTALL) -m 755    radsqlrelay$(EXEEXT)		$(R)$(bindir)
	$(INSTALL) -m 755    radtest 			$(R)$(bindir)
	$(INSTALL) -m 755    checkrad.pl		$(R)$(sbindir)/checkrad
