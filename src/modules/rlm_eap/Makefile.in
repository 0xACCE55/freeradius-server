#
# $Id$
#

TARGET      = @targetname@
SRCS        = rlm_eap.c eap.c mem.c state.c
HEADERS     = eap.h rlm_eap.h
RLM_CFLAGS  = $(INCLTDL) -Ilibeap
CLIENTLIBS  = libeap/libeap.la
RLM_LIBS    = libeap/libeap.la $(LIBLTDL)
RLM_INSTALL = install-subdirs
RLM_SUBDIRS = libeap @eaptypes@
RLM_UTILS   = radeapclient

#
#  Statically link a few modules.
#
STATIC_OBJS += $(shell ls -1 types/rlm_eap_md5/rlm_eap_md5.a types/rlm_eap_leap/rlm_eap_leap.a types/rlm_eap_tls/rlm_eap_tls.a types/rlm_eap_ttls/rlm_eap_ttls.a types/rlm_eap_sim/rlm_eap_sim.a 2>/dev/null)

## this uses the RLM_CFLAGS and RLM_LIBS and SRCS defs to make TARGET.
include ../rules.mak

$(STATIC_OBJS): $(HEADERS)

$(DYNAMIC_OBJS): $(HEADERS)

radeapclient: radeapclient.lo
	$(MAKE) $(MFLAGS) -C libeap $(WHAT_TO_MAKE)
	$(LIBTOOL) --mode=link $(CC) $(LDFLAGS) $(RLM_LDFLAGS) -static -o radeapclient radeapclient.lo $(CLIENTLIBS) $(LIBS)

radeapclient.lo: radeapclient.c $(HEADERS)
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) $(RLM_CFLAGS) -c radeapclient.c

install-subdirs:
	@$(MAKE) $(MFLAGS) WHAT_TO_MAKE=install common
	$(LIBTOOL) --mode=install $(INSTALL) -m 755 $(INSTALLSTRIP) radeapclient$(EXEEXT) $(R)$(bindir)

common:
	@for dir in $(RLM_SUBDIRS); do  \
		echo "Making $(WHAT_TO_MAKE) in $$dir..."; \
		(cd $$dir && $(MAKE) $(MFLAGS) $(WHAT_TO_MAKE)) || exit $?;\
	done

.PHONY: all install-subdirs common static dynamic
