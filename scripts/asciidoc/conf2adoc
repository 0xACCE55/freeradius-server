#!/usr/bin/env perl
#
#  $Id$
#
#  Convert conf files to Asciidoc
#
#

$was_raw = 0;
$raw = 0;
$blank = 0;

while (<>) {
    #
    #  Skip editor commands
    #
    if (/^# -\*- text -\*-/) {
	next;
    }

    if (/\$Id: /) {
	next;
    }

    # Skip ###### banners
    if (/^##+$/) {
	next;
    }

    # Print one line of blank text, but suppress multiple blank lines.
    if (/^\s*$/) {
	print "\n" if (!$blank);
	$blank = 1;
	next;
    }

    $blank = 0;

    undef $prefix;

    #
    #  Commented-out config blocks get converted to commented out raw text.
    #
    if (/^#[\t]/ || /^#[^\s]/) {
	$raw = 1;
#	print "R";

    #
    #  Comments in the configuration files get converted to plain
    #  text.
    #
    } elsif (/^\s*#/) {
	s/^\s*#[\t ]{0,2}//;

#	print "T";

	#
	#  Ensure that lists get formatted correctly
	#
	if (/^\s*\*/) {
	    $prefix = "  ";
	}

	$raw = 0;

    } else {
	$raw = 1;

#	print "C";
    }

    if ($raw != $was_raw) {
	print "```\n";
	$was_raw = $raw;
    }

    print $prefix if defined $prefix;

    #
    #  And print out the raw text.
    #
    print;
}

